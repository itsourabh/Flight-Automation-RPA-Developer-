**REGION Try
BLOCK 'File Creation'
ON BLOCK ERROR all

END
    SET EventDescription TO $'''%''%'''
    SET blnErrorFlag TO False
    SET blnScreenShots TO False
    SET blnCriticalFlag TO False
    DateTime.GetCurrentDateTime.Local DateTimeFormat: DateTime.DateTimeFormat.DateAndTime CurrentDateTime=> CurrentDateTime
    Text.ConvertDateTimeToText.FromCustomDateTime DateTime: CurrentDateTime CustomFormat: $'''ddMMyyy''' Result=> FormattedDateTime
    SET nbrMonth TO CurrentDateTime.Month
    SET nbrYear TO CurrentDateTime.Year
    **REGION File Validation
    File.GetPathPart File: $'''%gbl_strTempFolder%\\%gbl_dictConfig['InputFile']%''' FileName=> FileName2
    IF FileName2 <> gbl_dictConfig['InputFile'] THEN
        EXIT Code: 0 ErrorMessage: gbl_dictConfig['ERROR-004']
    ELSE
        File.Move Files: $'''%gbl_strTempFolder%\\%gbl_dictConfig['InputFile']%''' Destination: gbl_strInputFolder IfFileExists: File.IfExists.DoNothing MovedFiles=> MovedFiles3
    END
    **ENDREGION
    **REGION Column Validation
    SET strFilePath TO $'''%gbl_strInputFolder%\\%gbl_dictConfig['InputFile']%'''
    Database.Connect ConnectionString: $'''\"Provider=MSDASQL.1;Persist Security Info=False;Extended Properties=\"DSN=Excel Files;DBQ=%strFilePath%;DefaultDir=%gbl_strInputFolder%;DriverId=1046;MaxBufferSize=2048;PageTimeout=5;\"''' Connection=> SQLConnection
    Database.ExecuteSqlStatement.Execute Connection: SQLConnection Statement: $'''SELECT * FROM [Sheet1$]''' Timeout: 30 Result=> tblInput
    Database.Close Connection: SQLConnection
    Text.SplitText.SplitWithDelimiter Text: gbl_dictConfig['ColValidation'] CustomDelimiter: $''',''' IsRegEx: False Result=> lstColumns
    SET colIndex TO 0
    LOOP FOREACH recCol IN lstColumns
        IF tblInput.ColumnHeadersRow[colIndex] <> recCol THEN
            SET blnCriticalFlag TO True
            EXIT Code: 0 ErrorMessage: $'''%recCol% %gbl_dictConfig['ERROR-005']%'''
        END
        Variables.IncreaseVariable Value: colIndex IncrementValue: 1
    END
    **ENDREGION
    **REGION Row Validation
    File.Copy Files: $'''%gbl_strInputFolder%\\%gbl_dictConfig['InputFile']%''' Destination: gbl_strOutputFolder IfFileExists: File.IfExists.DoNothing CopiedFiles=> Travels
    SET strFilePathO TO $'''%gbl_strOutputFolder%\\%gbl_dictConfig['InputFile']%'''
    Excel.LaunchExcel.LaunchAndOpenUnderExistingProcess Path: $'''%gbl_strOutputFolder%\\%gbl_dictConfig['InputFile']%''' Visible: True ReadOnly: False UseMachineLocale: False Instance=> sesExcelInstance2
    Excel.GetFirstFreeColumnRow Instance: sesExcelInstance2 FirstFreeColumn=> FirstFreeColumn2 FirstFreeRow=> FirstFreeRow2
    Text.SplitText.SplitWithDelimiter Text: gbl_dictConfig['AddColumn'] CustomDelimiter: $''',''' IsRegEx: False Result=> lstAddColumn
    SET varCounter TO 0
    LOOP FOREACH recColumn IN lstAddColumn
        Excel.WriteToExcel.WriteCell Instance: sesExcelInstance2 Value: recColumn Column: FirstFreeColumn2 + varCounter Row: 1
        Variables.IncreaseVariable Value: varCounter IncrementValue: 1
    END
    Excel.CloseExcel.CloseAndSave Instance: sesExcelInstance2
    Database.Connect ConnectionString: $'''\"Provider=MSDASQL.1;Persist Security Info=False;Extended Properties=\"DSN=Excel Files;DBQ=%strFilePathO%;DefaultDir=%gbl_strOutputFolder%;DriverId=1046;MaxBufferSize=2048;PageTimeout=5;\"''' Connection=> SQLConnection1
    Database.ExecuteSqlStatement.Execute Connection: SQLConnection1 Statement: $'''SELECT * FROM [Sheet1$]''' Timeout: 30 Result=> tblTravel
    LOOP FOREACH recValid IN tblInput
        SET varValidation TO $'''%''%'''
        # *** Departure ***
        IF IsEmpty(recValid['Departure']) THEN
            SET varValidation TO gbl_dictConfig['ERROR-0025']
        END
        # *** Destination ***
        IF IsEmpty(recValid['Destination']) THEN
            SET varValidation TO gbl_dictConfig['ERROR-0026']
        END
        # *** Name ***
        IF IsEmpty(recValid['Name']) THEN
            SET varValidation TO gbl_dictConfig['ERROR-008']
        END
        # *** Email ***
        IF IsEmpty(recValid['Email']) THEN
            SET varValidation TO gbl_dictConfig['EmailError']
        END
        Text.ParseText.RegexParseForFirstOccurrence Text: recValid['Email'] TextToFind: gbl_dictConfig['Eregex'] StartingPosition: 0 IgnoreCase: False OccurrencePosition=> EmailPosition
        IF EmailPosition = (-1) THEN
            SET varValidation TO gbl_dictConfig['EmailInvalid']
        END
        # *** Address ***
        IF IsEmpty(recValid['Address']) THEN
            SET varValidation TO gbl_dictConfig['AddressError']
        END
        # *** City ***
        IF IsEmpty(recValid['City']) THEN
            SET varValidation TO gbl_dictConfig['CityError']
        END
        # *** State ***
        IF IsEmpty(recValid['State']) THEN
            SET varValidation TO gbl_dictConfig['StateError']
        END
        # *** ZipCode ***
        IF IsEmpty(recValid['ZipCode']) THEN
            SET varValidation TO gbl_dictConfig['ZipCodeEmpty']
        END
        Text.ParseText.RegexParseForFirstOccurrence Text: recValid['ZipCode'] TextToFind: gbl_dictConfig['Rezip'] StartingPosition: 0 IgnoreCase: False OccurrencePosition=> ZipPosition
        IF ZipPosition = (-1) THEN
            SET varValidation TO gbl_dictConfig['ZipCodeError']
        END
        # *** CardType ***
        IF IsEmpty(recValid['CardType']) THEN
            SET varValidation TO gbl_dictConfig['CardEmpty']
        END
        Text.SplitText.SplitWithDelimiter Text: gbl_dictConfig['ValidCard'] CustomDelimiter: $''',''' IsRegEx: False Result=> lstCard
        IF NotContains(lstCard, recValid['CardType'], False) THEN
            SET varValidation TO gbl_dictConfig['CardTypes']
        END
        # *** CreditCardNumber ***
        IF IsEmpty(recValid['CardNumber']) THEN
            SET varValidation TO gbl_dictConfig['NameOnCardError']
        END
        IF recValid['CardNumber'].Length <> 16 THEN
            SET varValidation TO gbl_dictConfig['NumError']
        END
        # *** Month And Year Validation ***
        Text.ParseText.RegexParseForFirstOccurrence Text: recValid['ExpMonth'] TextToFind: gbl_dictConfig['ExMonth'] StartingPosition: 0 IgnoreCase: False OccurrencePosition=> MonthPosition
        Text.ParseText.RegexParseForFirstOccurrence Text: recValid['ExpYear'] TextToFind: gbl_dictConfig['ExYear'] StartingPosition: 0 IgnoreCase: False OccurrencePosition=> YearPosition
        IF IsEmpty(recValid['ExpMonth']) THEN
            SET varValidation TO gbl_dictConfig['ERROR-0029']
        ELSE IF MonthPosition = (-1) THEN
            SET varValidation TO gbl_dictConfig['ERROR-0027']
        END
        IF IsEmpty(recValid['ExpYear']) THEN
            SET varValidation TO gbl_dictConfig['ERROR-0030']
        ELSE IF YearPosition = (-1) THEN
            SET varValidation TO gbl_dictConfig['ERROR-0028']
        END
        SET Year TO recValid['ExpYear']
        SET Month TO recValid['ExpMonth']
        IF Year < nbrYear THEN
            SET varValidation TO gbl_dictConfig['ExpYearError']
        ELSE
            IF Year = nbrYear THEN
                IF Month < nbrMonth THEN
                    SET varValidation TO gbl_dictConfig['ExpYearError']
                END
            END
        END
        # *** NameOnCard ***
        IF IsEmpty(recValid['NameOnCard']) THEN
            SET varValidation TO gbl_dictConfig['NameOnCardError']
        END
        # *** CVV Validation ***
        IF IsEmpty(recValid['CVV']) THEN
            SET varValidation TO gbl_dictConfig['CVV']
        END
        Text.FromNumber Number: recValid['CVV'] DecimalPlaces: 0 UseThousandsSeparator: True FormattedNumber=> txtCVV
        IF txtCVV.Length <> 3 THEN
            SET varValidation TO gbl_dictConfig['CVVError']
        END
        IF IsEmpty(varValidation) THEN
            Database.ExecuteSqlStatement.Execute Connection: SQLConnection1 Statement: $'''UPDATE [Sheet1$]
SET [Status] = \'Success\',
	[Remarks] = \'%varValidation%\'
WHERE [Name] = \'%recValid['Name']%\'''' Timeout: 30 Result=> QueryResult
            File.WriteText File: strTransactionLog TextToWrite: $'''%recValid['Departure']%,%recValid['Destination']%,%recValid['Name']%,%recValid['Email']%,%recValid['Address']%,%recValid['City']%,%recValid['State']%,%recValid['ZipCode']%,%recValid['CardType']%,%recValid['CardNumber']%,%recValid['ExpMonth']%,%recValid['ExpYear']%,%recValid['NameOnCard']%,%recValid['CVV']%,Success,%varValidation%''' AppendNewLine: True IfFileExists: File.IfFileExists.Append Encoding: File.FileEncoding.UTF8
        ELSE
            Database.ExecuteSqlStatement.Execute Connection: SQLConnection1 Statement: $'''UPDATE [Sheet1$]
SET [Status] = \'Fail\',
	[Remarks] = \'%varValidation%\'
WHERE [Name] = \'%recValid['Name']%\'''' Timeout: 30 Result=> QueryResult
            File.WriteText File: strTransactionLog TextToWrite: $'''%recValid['Departure']%,%recValid['Destination']%,%recValid['Name']%,%recValid['Email']%,%recValid['Address']%,%recValid['City']%,%recValid['State']%,%recValid['ZipCode']%,%recValid['CardType']%,%recValid['CardNumber']%,%recValid['ExpMonth']%,%recValid['ExpYear']%,%recValid['NameOnCard']%,%recValid['CVV']%,Fail,%varValidation%''' AppendNewLine: True IfFileExists: File.IfFileExists.Append Encoding: File.FileEncoding.UTF8
        END
    END
    Database.ExecuteSqlStatement.Execute Connection: SQLConnection1 Statement: $'''SELECT * From [Sheet1$]
WHERE [Status] = \'Success\'''' Timeout: 30 Result=> tblOutput
    Database.Close Connection: SQLConnection1
    **ENDREGION
END
**ENDREGION
**REGION Catch
ERROR => strLastError
IF IsNotEmpty(strLastError.Message) THEN
    SET EventDescription TO strLastError.Message
    SET EventLine TO strLastError.ActionIndex
    SET EventName TO strLastError.ActionName
    IF blnScreenShots = $'''True''' THEN
        CALL SF005_ScreentShots
    END
    File.WriteText File: strAuditLog TextToWrite: $'''%TimeStamp%,%gbl_strProcess%,%MachineName%,%UserName%,BSF001_File and Column Validation,INFO,,%EventDescription%,%EventLine%,%gbl_strScreenshotsFolder%,%EventName%''' AppendNewLine: True IfFileExists: File.IfFileExists.Append Encoding: File.FileEncoding.UTF8
    IF blnCriticalFlag = $'''True''' THEN
        CALL 'BSF003-Send Mail'
    END
END
**ENDREGION
